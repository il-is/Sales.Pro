# Логика расчета биллинга

## Обзор

Система автоматически рассчитывает биллинг для склада ответственного хранения на основе данных, полученных из API Wildberries. Расчет происходит для каждого юридического лица (компании) отдельно, с учетом индивидуальной конфигурации услуг и цен.

## Процесс генерации биллинга

### 1. Создание биллинга

Пользователь создает биллинг, указывая:
- **Компанию** (юридическое лицо)
- **Период расчета** (дата начала и дата окончания)

Биллинг создается со статусом `DRAFT` (черновик).

### 2. Генерация биллинга

При генерации биллинга (`POST /api/billing/[id]/generate`) происходит следующее:

#### 2.1. Проверки

1. **Проверка авторизации** - пользователь должен быть авторизован
2. **Проверка API ключа** - у компании должен быть настроен `wbApiKey` для Wildberries
3. **Проверка конфигурации** - у компании должна быть настроена конфигурация биллинга (`BillingConfig`)

#### 2.2. Получение данных из Wildberries API

Система параллельно запрашивает следующие данные через Wildberries API:

```typescript
const [stocks, fbsIncomes, fboSupplies, fbsOrders, operations, storageData] = 
  await Promise.all([
    wbService.getStocks(dateFrom),              // Остатки на складе
    wbService.getFBSIncomes(dateFrom, dateTo),   // Поступления FBS
    wbService.getFBOSupplies(dateFrom, dateTo), // Поставки FBO
    wbService.getFBSOrders(dateFrom, dateTo),   // Заказы FBS
    wbService.getWarehouseOperations(dateFrom, dateTo), // Складские операции
    wbService.getStorageData(dateFrom, dateTo), // Данные о хранении
  ])
```

**Параметры запросов:**
- `dateFrom` - дата начала периода (ISO строка)
- `dateTo` - дата окончания периода (ISO строка)

#### 2.3. Расчет биллинга

После получения данных вызывается `BillingCalculator.calculateBilling()`:

```typescript
BillingCalculator.calculateBilling(
  services,        // Массив услуг из конфигурации
  marketplaceData, // Данные из Wildberries
  periodStart,     // Дата начала периода
  periodEnd        // Дата окончания периода
)
```

#### 2.4. Сохранение результатов

Результаты сохраняются в базу данных:
- Статус биллинга меняется на `GENERATED`
- Сохраняется `totalAmount` (общая сумма)
- Сохраняется `marketplaceData` (JSON строка с данными из API)
- Сохраняется `calculations` (JSON строка с расчетами)

## Структура конфигурации услуг

Каждая компания имеет свою конфигурацию биллинга (`BillingConfig`), которая хранится в виде JSON строки:

```json
[
  {
    "id": "fbs",
    "name": "FBS (Отгрузка к покупателям)",
    "enabled": true,
    "price": 7.0,
    "unit": "за единицу",
    "description": "Количество товара, которое уехало к покупателям (FBS отгрузка)"
  },
  {
    "id": "fbo",
    "name": "FBO (Приемка на склад WB)",
    "enabled": true,
    "price": 5.0,
    "unit": "за единицу",
    "description": "Количество товара, принятого складом Wildberries (FBO приемка)"
  },
  {
    "id": "storage",
    "name": "Хранение",
    "enabled": false,
    "price": 10.5,
    "unit": "за м²/месяц",
    "description": "Хранение товаров на складе"
  },
  ...
]
```

**Поля услуги:**
- `id` - уникальный идентификатор услуги
- `name` - название услуги
- `enabled` - включена ли услуга в расчет (true/false)
- `price` - цена за единицу
- `unit` - единица измерения (опционально)
- `description` - описание услуги (опционально)

## Типы услуг и логика расчета

### 1. Хранение (`storage`)

**Источник данных:** `marketplaceData.storageData.items`

**Формула расчета:**
```
Количество дней хранения = (periodEnd - periodStart) в днях
Используемая площадь = сумма всех item.areaUsed из storageData.items
Сумма = Используемая площадь × Цена × (Количество дней / 30)
```

**Пример:**
- Период: 01.01.2024 - 31.01.2024 (31 день)
- Используемая площадь: 50 м²
- Цена: 10.5 руб/м²/месяц
- Расчет: 50 × 10.5 × (31 / 30) = 542.5 руб.

**Код:**
```typescript
case 'storage':
  if (marketplaceData.storageData?.items) {
    const storageDays = this.calculateStorageDays(periodStart, periodEnd)
    quantity = marketplaceData.storageData.items.reduce(
      (sum: number, item: any) => sum + (item.areaUsed || 0),
      0
    )
    total = quantity * service.price * (storageDays / 30) // Приводим к месяцам
  }
  break
```

### 2. FBS (тип операции)

**Источник данных:** `marketplaceData.fbsIncomes` (поставки типов FBS и FBW)

**Описание:** FBS - это тип операции, а не услуга. Получаем количество единиц из поставок (incomes) типов FBS и FBW за выбранный период. Это количество умножается на **все услуги** из настроек юридического лица.

**Формула расчета:**
```
FBS количество = сумма всех income.quantity из fbsIncomes
Для каждой услуги: Сумма = FBS количество × Цена услуги
```

**Пример:**
- Поставлено FBS/FBW: 231 единица
- Услуги в настройках:
  - Приемка: 5.0 руб/единицу
  - Отгрузка: 7.0 руб/единицу
- Расчет:
  - Приемка (FBS): 231 × 5.0 = 1 155 руб.
  - Отгрузка (FBS): 231 × 7.0 = 1 617 руб.

**Код:**
```typescript
// Подсчитываем количество FBS/FBW из поставок
let fbsQuantity = 0
if (marketplaceData.fbsIncomes && Array.isArray(marketplaceData.fbsIncomes)) {
  fbsQuantity = marketplaceData.fbsIncomes.reduce(
    (sum: number, income: any) => {
      const qty = income.quantity || income.inWayToClient || income.inWayFromClient || 0
      return sum + qty
    },
    0
  )
}

// Для каждой услуги умножаем на FBS количество
if (fbsQuantity > 0) {
  const fbsTotal = fbsQuantity * service.price
  items.push({
    serviceId: `${service.id}_fbs`,
    serviceName: `${service.name} (FBS)`,
    quantity: fbsQuantity,
    unit: service.unit || 'шт',
    price: service.price,
    total: fbsTotal,
    operationType: 'fbs',
  })
}
```

### 3. FBO (тип операции)

**Источник данных:** `marketplaceData.fbsOrders` (отгрузки типа FBO)

**Описание:** FBO - это тип операции, а не услуга. Получаем количество единиц из отгрузок (orders) типа FBO за выбранный период. Это количество умножается на **все услуги** из настроек юридического лица.

**Формула расчета:**
```
FBO количество = сумма всех order.quantity из fbsOrders (фильтр по типу FBO)
Для каждой услуги: Сумма = FBO количество × Цена услуги
```

**Пример:**
- Отгружено FBO: 187 единиц
- Услуги в настройках:
  - Приемка: 5.0 руб/единицу
  - Отгрузка: 7.0 руб/единицу
- Расчет:
  - Приемка (FBO): 187 × 5.0 = 935 руб.
  - Отгрузка (FBO): 187 × 7.0 = 1 309 руб.

**Код:**
```typescript
// Подсчитываем количество FBO из отгрузок
let fboQuantity = 0
if (marketplaceData.fbsOrders && Array.isArray(marketplaceData.fbsOrders)) {
  const fboOrders = marketplaceData.fbsOrders.filter((order: any) => {
    return !order.isCancel && (order.type === 'FBO' || order.orderType === 'FBO' || !order.type)
  })
  
  fboQuantity = fboOrders.reduce(
    (sum: number, order: any) => {
      const qty = order.quantity || 0
      return sum + qty
    },
    0
  )
}

// Для каждой услуги умножаем на FBO количество
if (fboQuantity > 0) {
  const fboTotal = fboQuantity * service.price
  items.push({
    serviceId: `${service.id}_fbo`,
    serviceName: `${service.name} (FBO)`,
    quantity: fboQuantity,
    unit: service.unit || 'шт',
    price: service.price,
    total: fboTotal,
    operationType: 'fbo',
  })
}
```

### 4. Комплектация (`handling`)

**Источник данных:** `marketplaceData.fbsOrders`

**Формула расчета:**
```
Количество = количество заказов (fbsOrders.length)
Сумма = Количество × Цена
```

**Пример:**
- Количество заказов: 85 заказов
- Цена: 15.0 руб/заказ
- Расчет: 85 × 15.0 = 1275 руб.

**Код:**
```typescript
case 'handling':
  if (marketplaceData.fbsOrders) {
    quantity = marketplaceData.fbsOrders.length
    total = quantity * service.price
  }
  break
```

### 5. Устаревшие типы услуг (для обратной совместимости)

**Приемка (`receiving`)** - устаревшее, используйте `fbo`
**Отгрузка (`shipping`)** - устаревшее, используйте `fbs`

Эти типы услуг поддерживаются для обратной совместимости со старыми конфигурациями, но рекомендуется использовать новые типы `fbs` и `fbo`.

### 6. Пользовательские услуги (default)

**Источник данных:** `marketplaceData.fbsOrders` (по умолчанию)

**Формула расчета:**
```
Количество = количество заказов (fbsOrders.length)
Сумма = Количество × Цена
```

**Пример:**
- Количество заказов: 25
- Цена: 20.0 руб/заказ
- Расчет: 25 × 20.0 = 500 руб.

**Код:**
```typescript
default:
  // Для пользовательских услуг используем базовую логику
  if (marketplaceData.fbsOrders) {
    quantity = marketplaceData.fbsOrders.length
    total = quantity * service.price
  }
```

## Алгоритм расчета

1. **Получение количества единиц:**
   - **FBS**: Подсчитывается количество единиц из поставок (incomes) типов FBS и FBW
   - **FBO**: Подсчитывается количество единиц из отгрузок (orders) типа FBO

2. **Фильтрация услуг:** берутся только услуги с `enabled: true`

3. **Итерация по услугам:**
   - Для каждой услуги (кроме `fbs`, `fbo`, `storage`, `handling`):
     - Количество FBS умножается на цену услуги → создается строка "Услуга (FBS)"
     - Количество FBO умножается на цену услуги → создается строка "Услуга (FBO)"
   - Для специальных услуг (`storage`, `handling`) используется их собственная логика

4. **Формирование результата:**
   - Создается массив `items` с расчетами по каждой услуге для FBS и FBO
   - Рассчитывается `subtotal` (сумма всех услуг)
   - `total = subtotal` (итоговая сумма)

5. **Возврат результата:**
   ```typescript
   {
     items: [
       {
         serviceId: "receiving_fbs",
         serviceName: "Приемка (FBS)",
         quantity: 231,
         unit: "шт",
         price: 5.0,
         total: 1155.0,
         operationType: "fbs"
       },
       {
         serviceId: "receiving_fbo",
         serviceName: "Приемка (FBO)",
         quantity: 187,
         unit: "шт",
         price: 5.0,
         total: 935.0,
         operationType: "fbo"
       },
       ...
     ],
     subtotal: 2090.0,
     total: 2090.0,
     period: {
       start: "2024-01-01T00:00:00.000Z",
       end: "2024-01-31T23:59:59.999Z"
     }
   }
   ```

## Вспомогательные функции

### calculateStorageDays()

Рассчитывает количество дней хранения между двумя датами:

```typescript
private static calculateStorageDays(start: Date, end: Date): number {
  const diffTime = end.getTime() - start.getTime()
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24))
}
```

**Пример:**
- start: 2024-01-01
- end: 2024-01-31
- Результат: 31 день

### formatCalculations()

Форматирует расчеты для отображения в UI (добавляет форматированные суммы в рублях):

```typescript
static formatCalculations(calculations: BillingCalculations): any {
  return {
    ...calculations,
    items: calculations.items.map((item) => ({
      ...item,
      formattedPrice: "10,50 ₽",
      formattedTotal: "542,50 ₽",
    })),
    formattedSubtotal: "3 907,50 ₽",
    formattedTotal: "3 907,50 ₽",
  }
}
```

## Особенности реализации

### 1. Учет только включенных услуг

В расчет попадают только услуги с `enabled: true`. Это позволяет временно отключать услуги без удаления из конфигурации.

### 2. Обработка отсутствующих данных

Если для услуги нет данных в `marketplaceData`, услуга не добавляется в результат (проверка `if (quantity > 0 || total > 0)`).

### 3. Приведение дней к месяцам для хранения

Для услуги "Хранение" дни хранения приводятся к месяцам: `(storageDays / 30)`. Это позволяет указывать цену за месяц, а не за день.

### 4. Параллельная загрузка данных

Все запросы к Wildberries API выполняются параллельно через `Promise.all()`, что ускоряет генерацию биллинга.

### 5. Сохранение исходных данных

Исходные данные из API сохраняются в `marketplaceData`, что позволяет:
- Проверить корректность расчетов
- Пересчитать биллинг при изменении конфигурации
- Аудит и отладку

## Пример полного расчета

**Входные данные:**
- Компания: "ИП Иванов"
- Период: 01.01.2024 - 31.01.2024
- Конфигурация услуг:
  - Приемка: 5.0 руб/единицу (включено)
  - Отгрузка: 7.0 руб/единицу (включено)
  - Комплектация: 15.0 руб/заказ (включено)
  - Хранение: 10.5 руб/м²/месяц (отключено)

**Данные из Wildberries:**
- fbsIncomes: [{ quantity: 100 }, { quantity: 131 }] → 231 единица (поставки FBS и FBW)
- fbsOrders (FBO): [{ quantity: 187 }] → 187 единиц (отгрузки FBO)

**Расчет:**

1. **Приемка (FBS):**
   - Количество: 231 единица
   - Расчет: 231 × 5.0 = 1 155 руб.

2. **Приемка (FBO):**
   - Количество: 187 единиц
   - Расчет: 187 × 5.0 = 935 руб.

3. **Отгрузка (FBS):**
   - Количество: 231 единица
   - Расчет: 231 × 7.0 = 1 617 руб.

4. **Отгрузка (FBO):**
   - Количество: 187 единиц
   - Расчет: 187 × 7.0 = 1 309 руб.

5. **Комплектация:**
   - Количество заказов: 1 заказ
   - Расчет: 1 × 15.0 = 15 руб.

**Итого:** 1 155 + 935 + 1 617 + 1 309 + 15 = **5 031 руб.**

## Статусы биллинга

- `DRAFT` - черновик, расчет еще не выполнен
- `GENERATED` - биллинг сгенерирован, расчеты готовы
- `SENT` - биллинг отправлен клиенту (будущая функциональность)
- `PAID` - биллинг оплачен (будущая функциональность)
- `CANCELLED` - биллинг отменен (будущая функциональность)

## Ограничения и замечания

1. **Точность расчета хранения:** Приведение дней к месяцам через деление на 30 может давать небольшую погрешность для месяцев с 28/29 или 31 днем.

2. **Зависимость от данных API:** Если Wildberries API не вернул данные для какой-то услуги, она не будет включена в расчет.

3. **Пользовательские услуги:** Для услуг с произвольным `id` используется базовая логика (количество поступлений), что может не подходить для всех случаев.

4. **Валидация данных:** Система не проверяет корректность данных из API (например, отрицательные количества). Рекомендуется добавить валидацию.

## Отладка и проверка данных

### Отладочный эндпоинт

Для проверки корректности данных из API Wildberries можно использовать отладочный эндпоинт:

```
GET /api/billing/[id]/debug
```

Этот эндпоинт возвращает:
- Количество записей из FBS incomes и FBO supplies
- Общее количество товаров по каждому типу
- Примеры записей с полями
- Структуру данных для анализа

**Пример использования:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:3000/api/billing/BILLING_ID/debug
```

### Логирование

В процессе генерации биллинга система логирует:
1. Параметры запросов к API (даты, эндпоинты)
2. Количество полученных записей
3. Примеры данных (первые 2 записи)
4. Детали расчета для каждой услуги
5. Итоговые расчеты

Логи выводятся в консоль сервера и помогают выявить проблемы с данными.

### Проверка расхождений

Если значения в биллинге не совпадают с данными в личном кабинете Wildberries:

1. **Проверьте период:** Убедитесь, что период биллинга соответствует периоду в личном кабинете
2. **Проверьте формат дат:** API требует формат `YYYY-MM-DD` без времени
3. **Проверьте структуру данных:** Используйте отладочный эндпоинт для просмотра структуры ответа API
4. **Проверьте логи:** Изучите логи сервера для выявления ошибок или несоответствий
5. **Проверьте типы поставок:** Убедитесь, что учитываются и FBS, и FBO поставки

## Возможные улучшения

1. **Более точный расчет хранения:** Учет фактических дней хранения каждого товара
2. **Взвешенное хранение:** Учет веса товаров при расчете хранения
3. **Дифференцированные тарифы:** Разные цены в зависимости от объема/периода
4. **Кэширование данных API:** Сохранение данных для ускорения пересчета
5. **Валидация данных:** Проверка корректности данных перед расчетом
6. **Логирование:** Детальное логирование процесса расчета для отладки
7. **UI для отладки:** Интерфейс для просмотра сырых данных из API

